import RPi.GPIO as GPIO
from time import sleep, time

# ========================================
# GPIO Setup
# ========================================
GPIO.setmode(GPIO.BCM)
GPIO.setwarnings(False)

# --- Upper Motor ---
Ena1, In1A, In1B = 2, 3, 4
GPIO.setup(Ena1, GPIO.OUT)
GPIO.setup(In1A, GPIO.OUT)
GPIO.setup(In1B, GPIO.OUT)
pwm1 = GPIO.PWM(Ena1, 100)
pwm1.start(0)

# --- Lower Motor ---
EnB, In2A, In2B = 17, 22, 27
GPIO.setup(EnB, GPIO.OUT)
GPIO.setup(In2A, GPIO.OUT)
GPIO.setup(In2B, GPIO.OUT)
pwm2 = GPIO.PWM(EnB, 100)
pwm2.start(0)

# --- Limit Switches (ê° ëª¨í„°ë‹¹ í•˜ë‚˜ì”©) ---
SWITCH_UPPER = 5   # Upper motorì˜ í•˜ë‹¨ ìŠ¤ìœ„ì¹˜
SWITCH_LOWER = 6   # Lower motorì˜ í•˜ë‹¨ ìŠ¤ìœ„ì¹˜

GPIO.setup(SWITCH_UPPER, GPIO.IN, pull_up_down=GPIO.PUD_UP)
GPIO.setup(SWITCH_LOWER, GPIO.IN, pull_up_down=GPIO.PUD_UP)

def is_upper_switch_pressed():
    return GPIO.input(SWITCH_UPPER) == GPIO.LOW

def is_lower_switch_pressed():
    return GPIO.input(SWITCH_LOWER) == GPIO.LOW

# ========================================
# Motor Control Functions
# ========================================
def upper_motor_up(speed=50):
    """Upper motor ìƒìŠ¹"""
    GPIO.output(In1A, GPIO.LOW)
    GPIO.output(In1B, GPIO.HIGH)
    pwm1.ChangeDutyCycle(speed)

def upper_motor_down(speed=50):
    """Upper motor í•˜ê°•"""
    GPIO.output(In1A, GPIO.HIGH)
    GPIO.output(In1B, GPIO.LOW)
    pwm1.ChangeDutyCycle(speed)

def upper_motor_stop():
    """Upper motor ì •ì§€"""
    GPIO.output(In1A, GPIO.LOW)
    GPIO.output(In1B, GPIO.LOW)
    pwm1.ChangeDutyCycle(0)

def lower_motor_up(speed=50):
    """Lower motor ìƒìŠ¹"""
    GPIO.output(In2A, GPIO.LOW)
    GPIO.output(In2B, GPIO.HIGH)
    pwm2.ChangeDutyCycle(speed)

def lower_motor_down(speed=50):
    """Lower motor í•˜ê°•"""
    GPIO.output(In2A, GPIO.HIGH)
    GPIO.output(In2B, GPIO.LOW)
    pwm2.ChangeDutyCycle(speed)

def lower_motor_stop():
    """Lower motor ì •ì§€"""
    GPIO.output(In2A, GPIO.LOW)
    GPIO.output(In2B, GPIO.LOW)
    pwm2.ChangeDutyCycle(0)

# ========================================
# Phase 1: ì´ˆê¸° ìƒíƒœ í™•ì¸ ë° í´ë¦¬ì–´
# ========================================
print("ğŸ”§ Initialization Phase 1: Checking initial switch states...")
print("")

MOTOR_SPEED = 50
UP_CLEAR_TIME = 2.0  # ìœ„ë¡œ ì˜¬ë¦¬ëŠ” ì‹œê°„ (ì´ˆ)

upper_needs_clear = is_upper_switch_pressed()
lower_needs_clear = is_lower_switch_pressed()

if upper_needs_clear:
    print("âš ï¸  UPPER switch is already pressed. Moving UP to clear...")
if lower_needs_clear:
    print("âš ï¸  LOWER switch is already pressed. Moving UP to clear...")

# ëˆŒë ¤ìˆëŠ” ëª¨í„°ë“¤ì„ ìœ„ë¡œ ì˜¬ë¦¬ê¸°
if upper_needs_clear or lower_needs_clear:
    start_time = time()
    while time() - start_time < UP_CLEAR_TIME:
        if upper_needs_clear:
            upper_motor_up(MOTOR_SPEED)
        if lower_needs_clear:
            lower_motor_up(MOTOR_SPEED)
        sleep(0.05)
    
    # ì •ì§€
    if upper_needs_clear:
        upper_motor_stop()
        print("âœ… UPPER motor cleared from switch")
    if lower_needs_clear:
        lower_motor_stop()
        print("âœ… LOWER motor cleared from switch")
    
    sleep(0.5)
else:
    print("âœ… No switches pressed initially. Proceeding directly to descent.")
    print("")

# ========================================
# Phase 2: ëª¨ë“  ëª¨í„°ë¥¼ í•˜ê°•ì‹œì¼œ ìŠ¤ìœ„ì¹˜ ëˆ„ë¥´ê¸°
# ========================================
print("")
print("ğŸ”§ Initialization Phase 2: Moving motors DOWN to find switches...")
print("")

upper_complete = False
lower_complete = False

try:
    while not (upper_complete and lower_complete):
        # Upper motor ì œì–´
        if not upper_complete:
            if is_upper_switch_pressed():
                upper_motor_stop()
                upper_complete = True
                print("âœ… UPPER motor switch pressed - STOPPED")
            else:
                upper_motor_down(MOTOR_SPEED)
        
        # Lower motor ì œì–´
        if not lower_complete:
            if is_lower_switch_pressed():
                lower_motor_stop()
                lower_complete = True
                print("âœ… LOWER motor switch pressed - STOPPED")
            else:
                lower_motor_down(MOTOR_SPEED)
        
        sleep(0.05)

    print("")
    print("="*50)
    print("ğŸ‰ Initialization Complete!")
    print("ğŸ‰ Both motors at bottom position!")
    print("="*50)

except KeyboardInterrupt:
    print("\nğŸ›‘ Interrupted by user.")

finally:
    upper_motor_stop()
    lower_motor_stop()
    pwm1.stop()
    pwm2.stop()
    GPIO.cleanup()
    print("âœ… Program terminated safely.")
