import RPi.GPIO as GPIO
from time import sleep

# ----------------------------
# Motor Setup (í•˜ë¶€ ëª¨í„°)
# ----------------------------
GPIO.setmode(GPIO.BCM)
GPIO.setwarnings(False)

Ena, In1, In2 = 2, 3, 4
GPIO.setup(Ena, GPIO.OUT)
GPIO.setup(In1, GPIO.OUT)
GPIO.setup(In2, GPIO.OUT)

pwm = GPIO.PWM(Ena, 100)  # 100Hz PWM
pwm.start(0)

# ----------------------------
# Limit Switch Setup
# ----------------------------
SWITCH_TOP = 6  # ìƒë‹¨ ë¦¬ë¯¸íŠ¸ ìŠ¤ìœ„ì¹˜
GPIO.setup(SWITCH_TOP, GPIO.IN, pull_up_down=GPIO.PUD_UP)

def is_top_pressed():
    return GPIO.input(SWITCH_TOP) == GPIO.HIGH  # ëˆŒë ¸ìœ¼ë©´ HIGH

# ----------------------------
# Motor Control
# ----------------------------
def motor_forward(speed=50, duration=0.1):
    """í•˜ë¶€ ëª¨í„° ì˜¬ë¦¬ê¸° (UP)"""
    if is_top_pressed():
        print("ğŸš« Top limit reached â€” stopping motor.")
        motor_stop()
        return
    GPIO.output(In1, GPIO.LOW)
    GPIO.output(In2, GPIO.HIGH)
    pwm.ChangeDutyCycle(speed)
    sleep(duration)
    motor_stop()

def motor_stop():
    GPIO.output(In1, GPIO.LOW)
    GPIO.output(In2, GPIO.LOW)
    pwm.ChangeDutyCycle(0)

# ----------------------------
# Main: ëª¨í„° ì˜¬ë¦¬ê¸° ë°˜ë³µ
# ----------------------------
try:
    print("ğŸ”¼ í•˜ë¶€ ëª¨ë‹ˆí„° ì•” ì˜¬ë¦¬ëŠ” ì¤‘...")
    while not is_top_pressed():
        motor_forward(speed=50, duration=0.2)  # 0.2ì´ˆì”© ì´ë™ ë°˜ë³µ
        sleep(0.1)
    print("âœ… ìƒë‹¨ ë¦¬ë¯¸íŠ¸ ë„ë‹¬ â€” ëª¨í„° ë©ˆì¶¤")

except KeyboardInterrupt:
    print("ğŸ›‘ ì‚¬ìš©ì ì¤‘ë‹¨")

finally:
    motor_stop()
    pwm.stop()
    GPIO.cleanup()
    print("í”„ë¡œê·¸ë¨ ì¢…ë£Œ")
